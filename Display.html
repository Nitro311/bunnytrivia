<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Bunny Trivia</title>

		<!-- Bootstrap -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">

		<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
		<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
		<!--[if lt IE 9]>
			<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
			<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
		<![endif]-->

		<style>
			.page {
				display: none;
				text-align: center;
			}

			.correct {
				background-color: green !important;
			}

			.navbar-brand {
				text-align: center;
				height: 80px;
			}

			.navbar-brand img {
				height: 50px;
			}

		</style>
	</head>
	<body>
		<div class="container">
			<nav class="navbar navbar-default">
				<div class="container-fluid">
					<div class="navbar-header">
						<a class="navbar-brand">
							<img src="/images/logo.png" alt="Bunny Trivia">
						</a>
					</div>
				</div>
			</nav>
			<div id="displaywaitingpage" class="page">
				Waiting for players
				<table class="table table-striped" id="waitingtable">
					<thead>
						<tr>
							<th>Player</th>
							<th>Ready</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td colspan="2"><em>Loading...</em></td>
						</tr>
						<tr>
							<td colspan="2"><img src="/images/spinner.gif"></td>
						</tr>
					</tbody>
				</table>

				<p>
					Room code:
					<h1><div id="roomcode"></div></h1>
				</p>
				Visit
				<div id="roomurl"></div>
				Or scan to play
				<div id="qrdiv"></div>
				<br />

				<button id="startnowbutton">Start Now!</button>

			</div>

			<div class="page" id="gamestartedpage">
				Game Name
				Round X
			</div>

			<div class="page" id="questionpage">
				How many polar bears does it take to change a light bulb?

				<div class="progress">
					<div class="progress-bar progress-bar-striped" role="progressbar" id="timeleftprogressbar"><span class="sr-only">60% Complete</span></div>
				</div>
			</div>

			<div class="page" id="answerspage">
				<table class="table table-striped">
					<thead>
						<tr>
							<th>Player</th>
							<th>Answer</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td>Alex</td>
							<td>16</td>
						</tr>
						<tr>
							<td>Emily</td>
							<td>8</td>
						</tr>
						<tr class="correct">
							<td>Aaron</td>
							<td>47</td>
						</tr>
					</tbody>
				</table>
			</div>

			<div class="page" id="scoringpage">
				<table class="table table-striped">
					<thead>
						<tr>
							<th>Player</th>
							<th>Score</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td>Alex</td>
							<td>1000</td>
						</tr>
						<tr>
							<td>Emily</td>
							<td>500</td>
						</tr>
						<tr>
							<td>Aaron</td>
							<td>-1000</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
		<script src='/_ah/channel/jsapi'></script>

		<script>
			var room_id = '{{ room }}';

			var timeToShowQuestionSeconds = 3;
			var timeToShowRoundPageSeconds = 3;
			var questionTimeRemaining;
			var gameTimer;

			function showQuestionPage() {
				$('.page').hide();
				$('#questionpage').show();

				questionTimeRemaining = timeToShowQuestionSeconds;
				questionCountdown();
			}

			function questionCountdown() {
				// update the display for the remaining time
				var percent = 100.0 * questionTimeRemaining / timeToShowQuestionSeconds;
				$('#timeleftprogressbar').attr('style', 'width:' + percent + '%');

				questionTimeRemaining -= 1;

				if (questionTimeRemaining >= -1) {
					gameTimer = setTimeout(questionCountdown, 1000);
				} else {
					showAnswersPage();
				}
			}

			function showAnswersPage() {
				$('.page').hide();
				$('#answerspage').show();

				gameTimer = setTimeout(showScoringPage, 3000);
			}

			function showScoringPage() {
				$('.page').hide();
				$('#scoringpage').show();

				gameTimer = setTimeout(showQuestionPage, 3000);
			}

			$('#startnowbutton').on('click', function(){
				$('.page').hide();
				$('#gamestartedpage').show();
				gameTimer = setTimeout(showQuestionPage, timeToShowRoundPageSeconds * 1000);
			});


			$('#startbutton').on('click', function() {
				$('.page').hide();
				$('#displaywaitingpage').show();
			});

			function setRoomCode(room_id) {
				var url = window.location;
				var roomUrl = url.protocol + "//" + url.hostname + ":" + url.port + "/player/" + room_id;

				$('#roomcode').text(room_id);
				$('#roomurl').text(roomUrl);				
				$('#qrdiv').qrcode({
					text: roomUrl,
					height: 128,
					width: 128,
					background: '#ffffff',
					foreground: '#000000'
				});
			}

			setRoomCode(room_id);
			$('#displaywaitingpage').show();

			// Messaging
			sendMessage = function(path) {
				$.post(path, "token=" + escape(token));
				console.log("POSTing to " + path + " for token " + token);
			}

			var token = '{{ channel_token }}';
			var channel = new goog.appengine.Channel(token);
			var socket = channel.open();
			socket.onopen = function() {
				window.setTimeout(function() { sendMessage('/api'); }, 100);
			}
			socket.onmessage = function(evt) {
				var eventData = JSON.parse(evt.data);

				console.log("Message received " + JSON.stringify(eventData));

				// TODO: Handle messages

				if (eventData.message_type == "connected") {
					sendMessage('/api/room/' + room_id);
				} else if (eventData.message_type == "room") {
					if (eventData.status == "waiting") {
						$('#waitingtable tbody').empty();
						if (eventData.players.length == 0) {
							$('#waitingtable tbody').append($('<tr><td colspan="2"><em>Waiting for players...</em></td></tr>'));
						}
						for (index in eventData.players) {
							player = eventData.players[index];
							$('#waitingtable tbody').append($('<tr><td>' + player + '</td></tr>'));
						}

						window.setTimeout(function() { sendMessage('/api/room/' + room_id); }, 500);
					}
				}
			}
		</script>
	</body>
</html>
