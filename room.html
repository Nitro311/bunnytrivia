<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Bunny Trivia</title>

		<!-- Bootstrap -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">

		<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
		<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
		<!--[if lt IE 9]>
			<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
			<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
		<![endif]-->

		<style>
			.navbar-brand img {
				max-height: 50px;
				max-width: 70%;
			}

			#nickname form {
				display: inline;
			}

			.disconnected {
				background-color: red;
			}

			.connected {
				background-color: green;
			}

			h1 {

			}

			input[type=text] {
				text-transform: uppercase;
			}
		</style>
	</head>
	<body>
		<nav class="navbar navbar-default">
			<div class="container">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="navbar-brand" href="#"><img src="/images/logo.png" alt="Bunny Trivia"></a>
				</div>
				<div id="navbar" class="collapse navbar-collapse">
					<ul class="nav navbar-nav navbar-right">
						<li id="nickname"></li>
						<li id="state" class="disconnected">Connection</li>
					</ul>
				</div>
			</div>
		</nav>

		<div class="container">
			<div id="main" class="page">
			</div>
		</div>

		<script id="newnicknametemplate" type="text/x-handlebars-template">
			<form id="newnicknameform" onsubmit="return setNickname()">
				<div class="input-group input-group-lg">
					<input class="form-control" type="text" id="newnickname" placeholder="Enter nickname" value="{% templatetag openvariable %}this{% templatetag closevariable %}" autofocus />
					<span class="input-group-btn">
						<button type="submit" class="btn btn-default">Set</button>
					</span>
				</div>
			</form>
		</script>


		<script id="waitingroomtemplate" type="text/x-handlebars-template">
			<table class="table table-striped" id="waitingtable">
				<thead>
					<tr>
						<th>Player</th>
						<th>Ready</th>
					</tr>
				</thead>
				<tbody>
					{% templatetag openvariable %}#users{% templatetag closevariable %}
					<tr>
						<td>{% templatetag openvariable %}nickname{% templatetag closevariable %}</td>
						<td>{% templatetag openvariable %}is_ready{% templatetag closevariable %}</td>
					</tr>
					{% templatetag openvariable %}/users{% templatetag closevariable %}
				</tbody>
			</table>
			<button id="startgamenow" class="btn btn-lg btn-success">Start Now</button>
		</script>

		<script id="startroundtemplate" type="text/x-handlebars-template">
			<div style="text-align:center">
				<h1> Round {% templatetag openvariable %}round{% templatetag closevariable %}</h1>
			</div>
		</script>
		<script id="askingquestiontemplate" type="text/x-handlebars-template">
			<div style="text-align:center">
				<h1>{% templatetag openvariable %}question{% templatetag closevariable %}</h1>
				<form id="answerform" onsubmit="return sendAnswer()">
					<input type="text" id="answer"  autofocus autocomplete="off"/>
					<button type="submit" class="btn btn-lg btn-success">Ok</button>
				</form>
			</div>
		</script>

		<script id="answeredquestiontemplate" type="text/x-handlebars-template">
			<div style="text-align:center">
				<h1>Question is over!</h1>
				<h1>{% templatetag openvariable %}question{% templatetag closevariable %}</h1>
				<table class="table table-striped" id="waitingtable">
					<thead>
						<tr>
							<th>Player:</th>
							<th>Answer:</th>
						</tr>
					</thead>
					<tbody>
						{% templatetag openvariable %}#answers{% templatetag closevariable %}
						<tr>
							<td>{% templatetag openvariable %}nickname{% templatetag closevariable %}</td>
							<td>{% templatetag openvariable %}answer{% templatetag closevariable %}</td>
						</tr>
						{% templatetag openvariable %}/answers{% templatetag closevariable %}
					</tbody>
				</table>
			</div>
		</script>



		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0/handlebars.min.js"></script>
		<script src="/_ah/channel/jsapi"></script>

		<script>

			// Cookies
			function createCookie(name, value, days) {
				var expires = '';

				if (days) {
					var date = new Date();
					date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
					expires = '; expires=' + date.toGMTString();
				}
				document.cookie = escape(name) + '=' + escape(value) + expires + '; path=/';
			}

			function readCookie(name) {
				var nameEQ = escape(name) + '=';
				var ca = document.cookie.split(';');
				for (var i = 0; i < ca.length; i++) {
					var c = ca[i];
					while (c.charAt(0) === ' ')
						c = c.substring(1, c.length);
					if (c.indexOf(nameEQ) === 0)
						return unescape(c.substring(nameEQ.length, c.length));
				}
				return null;
			}

			function eraseCookie(name) {
				createCookie(name, '', -1);
			}

			// Messaging
			function sendMessage(route, data) {
				var path = '/room/{{ room_id }}' + route;
				console.log('POST: ' + path + " " + (data || ''));
				$.post(path, data);
			}

			function establishMessaging() {
				var token = '{{ channel_token }}';
				var channel = new goog.appengine.Channel(token);
				var socket = channel.open();
				socket.onopen = function() {
					window.setTimeout(function() { sendMessage('/connect'); }, 100);
				};
				socket.onmessage = function(evt) {
					var eventData = JSON.parse(evt.data);
					console.log('Message(s) received ' + JSON.stringify(eventData));
					$.each(eventData, function(index, value) { handleMessage(value); });
				};
			}

			function handleMessage(data) {
				if (data.message_type === 'connected') {
					console.log('Connect message received');
					$('#state').addClass('connected');
					$('#state').removeClass('disconnected');

					if (!nickname) {
						$('#nickname').renderTemplate($('#newnicknametemplate'), nickname);
					}
				} else if (data.message_type === 'newnickname') {
					console.log('New nickname received');
					nickname = data.newnickname;
					drawNickname();
				} else if (data.message_type === 'room') {
					console.log('Room state received');
					if (data.room.status === 'waiting') {
						$('#main').renderTemplate($('#waitingroomtemplate'), data.room);
					} else if (data.room.status === 'started') {
						$('#main').renderTemplate($('#startroundtemplate'), data.room);
						// TODO: Set timer and re-request game state in x seconds
					} else if (data.room.status === 'askingquestion') {
						$('#main').renderTemplate($('#askingquestiontemplate'), data.room);
					} else if (data.room.status === 'answeredquestion') {
						$('#main').renderTemplate($('#answeredquestiontemplate'), data.room);
					} else {
						console.log('Unknown room status: ' + JSON.stringify(data));
					}
				} else {
					console.log('Unknown message received: ' + JSON.stringify(data));
				}
			}

			// Templating
			var compiled = {};
			$.fn.renderTemplate = function(template, data) {
				if (template instanceof jQuery) {
					template = $(template).html();
				}

				compiled[template] = Handlebars.compile(template);
				this.html(compiled[template](data));
			};


			// Miscellaneous
			function showLoading() {
				$('#main').html('<div style="text-align: center"><img src="/images/spinner.gif"></div>');
			}

			function drawNickname() {
				$('#nickname').html('<a href="#"></a>');
				$('#nickname a').text(nickname);
			}

			function setNickname() {
				newNickname = $('#newnicknameform input').val();
				if (newNickname && newNickname.trim() && newNickname !== nickname) {
					sendMessage('/setnickname', { 'newnickname': newNickname.trim() });
				} else if (nickname) {
					drawNickname();
				}
				return false;
			}

			function sendAnswer() {
				answer = $('#answerform input').val();
				if (answer) {
					sendMessage('/sendanswer', 'answer=' + answer);
				}
				return false;
			}
			
			function startupCommands() {
				drawNickname();
				showLoading();
				establishMessaging();

				$('#nickname').on('click', 'a', function() {
					$('#nickname').renderTemplate($('#newnicknametemplate'), nickname);
				});

				$('body').on('click', '#startgamenow', function() {
					if (nickname) {
						sendMessage('/startgame');
					} else {
						$('#nickname input').focus();
					}
				});
			}

			$(function() {
				startupCommands();
			});

			var room_id = '{{ room_id }}';
			var nickname = '{{ nickname }}';
		</script>
	</body>
</html>
